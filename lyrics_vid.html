<!DOCTYPE html>
<html lang="en">
<head>
  <title>Make a lyrics video</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <style>
  .line_text {
    cursor: pointer;
    border-style: solid;
    border-width: 1px;
    border-color: blue;
    background-color: lightblue;
  }
  .selected {
    background-color: pink;
  }
  .lyrics_array {
    height:200px;
    width: 100%;
    border:1px solid #ccc;
    overflow: scroll;
  }
  #video_container {
    position: relative;
  }

  #vid {
  }
  #preview_container {
    position: absolute;
    width: 100%;
    bottom: 0;
    background: rgba(255,255,255,0.5);
    pointer-events: none;
  }
  #preview {
    font-family: sans-serif;
    font-size: 50px;
    line-height: 2;
    text-align: center;
    vertical-align: middle;
    color: black;
    pointer-events: none;
  }
  .time {
    cursor: pointer;
    color:blue;
    text-decoration: underline;
  }
  .delete {
    cursor: pointer;
    color:red;
    text-decoration: underline;
  }
  .lyrics_text {
    cursor: pointer;
  }
  </style>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="mousetrap.min.js"></script>
  <script src="ffmpeg-webm.min.js"></script>
  <!-- <script src="ffmpeg-all-codecs.js"></script> -->
  <script>
    $(document).ready(function() {
      $('#process').on('click', process_lyrics);
      $('#clear').on('click', function(){
        $('#lyrics').val('');
      });
      $('#sub_file').on('change', function(evt){
        if(window.timecodes.length > 0){
          if(!confirm('Are you sure you want to load a new set of subs and wipe existing timings?')) return;
        }
        var f = this.files[0];
        const reader = new FileReader();
        reader.addEventListener('load', (event) => {
          load_subs(event.target.result);
        });
        reader.readAsText(f);
      });
      $('#save_subs').on('click', save_subs);
      $('#vid_file').on('change', function(evt){
          var source = $('#video_here');
          var f = this.files[0];
          if(f.type.match('video.*')){
            source[0].src = URL.createObjectURL(f);
          }else if(f.type.match('audio.*')){
            $('#video_container').html('<p style="padding-bottom:100px;"/><audio id="vid" controls="true"><source src="https://files.freemusicarchive.org/storage-freemusicarchive-org/music/WFMU/Broke_For_Free/Directionless_EP/Broke_For_Free_-_01_-_Night_Owl.mp3" id="video_here" />Your browser does not support HTML5 audio.</audio><div id="preview_container"><div id="preview"></div></div>');
            $('#video_here').src = URL.createObjectURL(f);
            $('#vid').videoWidth = 640; // Placeholder to stop breakage
            $('#vid').videoHeight = 480; // Placeholder to stop breakage
            $('#vid').on('canplay', vid_ready); // Reinstate events
            $('#vid').on('timeupdate', sync_lyrics); // Reinstate events
          }

          source.parent()[0].load();
      });
      $('#vid').on('canplay', vid_ready);
      $('#vid').on('timeupdate', sync_lyrics);
      $('#make_video').on('click', process_video);
      $('#export_srt').on('click', export_srt);
      $('#export_ass').on('click', export_ass);
      $('.instructions').hide();
      $('.options').hide();
      $('.opt_control').on('change', change_opt);
      $('.opt_control').on('input', change_opt);
      $('.slider').on('input', adjust_range);
      $('#in_browser').on('click', browser_video);
      $('#lyrics').on('keyup', function(e){
        if(e.keyCode === 13 && e.shiftKey){
          e.preventDefault();
          process_lyrics();
        }
      });
      $('#single_line').on('keyup', function(e){
        if(e.keyCode === 13){
          e.preventDefault();
          add_line();
        }
      });
      $('#add').on('click', add_line);
      $('#opts').on('click', function(){
        $('.options').toggle();
      });
      $('#ffmpeg').hide();
      //$('#list_div').hide();
      window.selected_line = -1;
      window.timecodes = [];
      window.ids = 0;
      window.opts = {
        text_colour: "#000000",
        bg_colour: "#ffffff", // Alpha needed too
        font_size: 50, // pixels
        bg_type: "full", // possibilities: 'full' border, 'box' box, 'none'
        bg_border: 0,
        bg_opacity: 0.5,
        out_colour: "#000000",
        out_size: 0,
        shad_colour: "#000000",
        shad_off: 0,
        font: 'sans-serif'
      };

      if(storageAvailable('localStorage')){
        $('#save_opts').on('click', save_opts);
        $('#reset_opts').on('click', load_opts);
        $('#wipe_opts').on('click', wipe_opts);
        load_opts();
      }else{
        $('#saving').hide();
      }
      //window.font_options = ["Arial", "Times New Roman", "Verdana", "Courier New"];
      window.os_specific = {
        "Mac": {
          script_ext: 'command',
          script: '#!/bin/bash\necho "Enter the name of the input video (you can probably just drag and drop it on this window):"\nread -r name\nffmpeg -i ${name} ',
          script_mime: 'application/x-shellscript'
        },
        "*nix": {
          script_ext: 'sh',
          script: '#!/bin/bash\necho "Enter the name of the input video (you can probably just drag and drop it on this window):"\nread -r name\nffmpeg -i ${name} ',
          script_mime: 'application/x-shellscript'
        },
        "Windows":{
          script_ext: 'bat',
          script: '@ECHO OFF\nset /P name="Enter the path of the input video: "\nffmpeg -i %name% ',
          script_mime: 'application/x-bat'
        }
      }
      set_os();
      set_opt_controls();
      display_opts();
      window.isWorkerLoaded = false;
      window.worker = null;
      window.ffmpeg_running = false;
      $('#ffmpeg_log').hide();
      init_worker();
      Mousetrap.bind('space', function(e){
        if (e.preventDefault) {
        e.preventDefault();
    } else {
        // internet explorer
        e.returnValue = false;
    }
        playpause();
      });
      Mousetrap.bind('down', function(e){
        if (e.preventDefault) {
        e.preventDefault();
    } else {
        // internet explorer
        e.returnValue = false;
    }
        next_lyric();
      });
      Mousetrap.bind('up', function(e){
        if (e.preventDefault) {
        e.preventDefault();
    } else {
        // internet explorer
        e.returnValue = false;
    }
       prev_lyric();
      });
      $('#lyrics').focus();

          Mousetrap.prototype.stopCallback = function(e, element, combo) {
            if ((' ' + element.className + ' ').indexOf(' mousetrap ') > -1) {
              if(combo != 'space') return false;
          }

          // stop for input, select, and textarea
          return element.tagName == 'INPUT' || element.tagName == 'SELECT' || element.tagName == 'TEXTAREA' || (element.contentEditable && element.contentEditable == 'true');

          }
    });

    function set_os(){
      if (navigator.userAgent.indexOf("Win")!=-1) window.osname="Windows";
      if (navigator.userAgent.indexOf("Mac")!=-1) window.osname="Mac";
      if (navigator.userAgent.indexOf("X11")!=-1) window.osname="*nix";
      if (navigator.userAgent.indexOf("Linux")!=-1) window.osname="*nix";
    }

    function textcol(){
      $('#preview').css('color', $('#text_colour').val());
    }

    function display_opts(){
      $('#preview').css('color', window.opts.text_colour);
      var bg_colour = "rgba(" + window.opts.bg_colour.match(/[A-Za-z0-9]{2}/g).map(function(v) { return parseInt(v, 16) }).join(",") + ","+window.opts.bg_opacity+")";

      $('#preview_container').css('background', bg_colour);
      $('#preview').css('font-size', window.opts.font_size/2 +'px');
      $('#preview').css('-webkit-text-stroke', window.opts.out_size + 'px '+ window.opts.out_colour);
      //console.log(window.opts.out_colour);
      $('#preview').css('text-shadow', window.opts.shad_off + 'px ' + window.opts.shad_off + 'px' + window.opts.shad_colour);
      $('#preview').css('font-family', window.opts.font);
    }

    function set_opt_controls(){
      for(o in window.opts){
        $('#'+o).val(window.opts[o]);
      };
      $('#font_size_range').val(window.opts.font_size);
      $('#bg_opacity_range').val(window.opts.bg_opacity);
      $('#out_size_range').val(window.opts.out_size);
      $('#shad_off_range').val(window.opts.shad_off);
    }

    function openTab(evt, tabName) {
      var i;
      var x = document.getElementsByClassName("tab_option");
      for (i = 0; i < x.length; i++) {
        x[i].style.display = "none";
      }
      tablinks = document.getElementsByClassName("tablink");
      for (i = 0; i < x.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" w3-blue", "");
      }
      document.getElementById(tabName).style.display = "block";
      evt.currentTarget.className += " w3-blue";
    }


    function goto_time(id){
      if(id.match(/start/)){
        var num = id.substring(6);
        $('#vid')[0].currentTime = window.timecodes[num].start;
      }else if(id.match(/end/)){
        var num = id.substring(4);
        $('#vid')[0].currentTime = window.timecodes[num].end;
      }
    }

    function set_time(id){
      if(id.match(/start/)){
        var num = id.substring(6);
        window.timecodes[num].start = $('#vid')[0].currentTime;
      }else if(id.match(/end/)){
        var num = id.substring(4);
        window.timecodes[num].end = $('#vid')[0].currentTime;
      }
      update_list();
    }

    function delete_sub(){
      var id = $(this).attr('id').substring(7);
      window.timecodes.splice(id, 1);
      update_list();
    }

    function bgcol(){
      $('#preview_container').css('background', $('#bg_colour').val()+'88');
    }

    function vid_ready(){
      $('#video_container').width($('#vid')[0].videoWidth/2);
      $('#vid').width($('#video_container').width());
    }

    function change_opt(){
      var opt = $(this).attr('id');
      window.opts[opt] = $(this).val();
      display_opts();
    }

    function escape_filter_option(text){
      return text.replace(/([:'])/g, "\\$1");
    }
    function escape_filter_description(text){
      return text.replace(/([\[\]\\\',;])/g, "\\$1");
    }

    function escape_filtergraph_for_shell(text){
      return text.replace(/\\/g, '\\\\');
    }

    function time_to_hms(time){
      if(!time){
        if($('#vid')[0].duration) return time_to_hms($('#vid')[0].duration);
        return '00:00:00,000';
      }
      var s = Math.floor(time);
      var ms = Math.floor ((time - s)*1000);
      var date = new Date(null);
      date.setSeconds(s, ms);
      return date.toISOString().substr(11, 12).replace(/\./, ',');
    }

    function ffmpeg_ready(){
      return !window.ffmpeg_running && window.isWorkerLoaded && window.timecodes.length;
    }

    function ffmpeg_start(){
      window.ffmpeg_running = true;
      $('#ffmpeg_log').show();
      $('#in_browser').hide();
    }

    function ffmpeg_stop(){
      window.ffmpeg_running = false;
      $('#ffmpeg_log').hide();
      $('#in_browser').show();
    }

    function time_to_ass(time){
      if(!time){
        if($('#vid')[0].duration) return time_to_ass($('#vid')[0].duration);
        return '0:00:00.00';
      }
      var s = Math.floor(time);
      var hs = Math.floor ((time - s)*100);
      var date = new Date(null);
      date.setSeconds(s, hs*10);
      return date.toISOString().substr(12, 10);
    }

    function export_srt(){
      var file = '';
      for(var i = 0; i < window.timecodes.length; i++){
        var num = i+1;
        file += '' + num + '\n';
        file += time_to_hms(window.timecodes[i].start) + ' --> '+time_to_hms(window.timecodes[i].end) + '\n';
        file += window.timecodes[i].text+'\n\n';

      }
      download(file, "lyrics.srt", 'text/srt');
    }

    function rgb_to_bgr(col, alpha = 1){
      // Can presume 7-digit hex notation
      var r = col[1]+col[2];
      var g = col[3]+col[4];
      var b = col[5]+col[6];
      var a = Math.round(alpha * 255).toString(16);
      return '&H'+a.toUpperCase()+b.toUpperCase()+g.toUpperCase()+r.toUpperCase()+'&';
    }

    function export_ass(){
      var wrap = 0;
      var spacer = '';
      if(window.opts.bg_type == "full"){
        wrap = 2; // For workaround to enable full-width box
        var char = 'G';
        var num = Math.floor($('#vid')[0].videoWidth / (window.opts.font_size * 2));
        spacer = '{\\1a&HFF&}{\\bord0}{\\shad0}'+char.repeat(num)+'{\\r}{\\1a&H00&}';
      }
      var res=false;
      var res_text = '';
      if(res) res_text = 'PlayResX: '+$('#vid')[0].videoWidth+'\nPlayResY: '+$('#vid')[0].videoHeight+'\n';
      var file = '[Script Info]\nScriptType: V4.00+\n'+res_text+'WrapStyle: '+wrap+'\n\n';
      file += '[V4+ Styles]\nFormat: Name, Fontname, Fontsize, PrimaryColour, BackColour, OutlineColour, Bold, Italic, BorderStyle, Outline, Shadow, Alignment, MarginL, MarginR, MarginV\n';
      file += 'Style: Default,Arial,'+window.opts.font_size+','+rgb_to_bgr(window.opts.text_colour)+','+rgb_to_bgr(window.opts.bg_colour, window.opts.bg_opacity)+','+rgb_to_bgr(window.opts.out_colour, 1)+',0,0,4,'+window.opts.out_size+','+window.opts.shad_off+',2,0,0,0\n\n'; // TODO update with variables
      file += '[Events]\nFormat: Start, End, Style, Text\n';
      for(var i = 0; i < window.timecodes.length; i++){
        var num = i+1;
        file += 'Dialogue: '+time_to_ass(window.timecodes[i].start) + ',' + time_to_ass(window.timecodes[i].end) + ',Default,'+spacer+window.timecodes[i].text+spacer+'\n';
      }
      download(file, "lyrics.ass", 'text/ass');
    }

    function playpause(){
      if($('#vid')[0].paused) $('#vid')[0].play();
      else $('#vid')[0].pause();
    }

    function next_lyric(){
      if(window.selected_line == window.ids - 1){
        $('#lyric_text_'+window.selected_line).trigger('click');
        return; // To deselect last one
      }
      var new_id = +window.selected_line+1; // Means when nothing is selected it will move to the start
      $('#lyric_text_'+new_id).trigger('click');
    }

    function prev_lyric(){
      if(window.selected_line < 0){
        var num = +window.ids - 1;
        $('#lyric_text_'+num).trigger('click');
        return;
      }; // No prev ID
      if(window.selected_line == 0){
        $('#lyric_text_0').trigger('click');  // To deselect
        return;
      }
      var new_id = window.selected_line-1;
      $('#lyric_text_'+new_id).trigger('click');
    }


    function download(data, filename, type) {
    var file = new Blob([data], {type: type});
    if (window.navigator.msSaveOrOpenBlob) // IE10+
        window.navigator.msSaveOrOpenBlob(file, filename);
    else { // Others
        var a = document.createElement("a"),
                url = URL.createObjectURL(file);
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        setTimeout(function() {
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }, 0);
    }
}

    function process_lyrics(){
      var lyrics = $.trim($('#lyrics').val());
      $('#lyrics').val('');
      $('#lyrics').blur();
      if(lyrics === '') return;
      //window.timecodes = []; // Reset everything
      var lines = lyrics.match(/[^\r\n]+/g);
      var inside = '';
      lines.forEach(function(line){
        inside += '<div id="lyric_line_'+window.ids+'"></div><span class="line_text" id="lyric_text_'+window.ids+'">'+line+'</span>' // from <span id="lyric_start_'+ln+'">0</span> seconds to <span id="lyric_end_'+ln+'">0</span> seconds</div>';
        window.ids++;
      });
      existing = $('#lyrics_array').html();
      $('#lyrics_array').html(existing+inside);
      $('.line_text').on('click', click_line);
      var evt = new MouseEvent('click', {view: window, bubbles: true, cancelable: true});
      $('#place_tab')[0].dispatchEvent(evt);
    }

    function add_line(){
      var h = $('#lyrics_array').html();
      var line = $('#single_line').val();
      $('#single_line').val('');
      //$('#single_line').blur();
      if(line === '') return;
      h += '<div id="lyric_line_'+window.ids+'"></div><span class="line_text" id="lyric_text_'+window.ids+'">'+line+'</span>';
      window.ids++;
      $('#lyrics_array').html(h);
      $('.line_text').on('click', click_line);
      // Auto-click line
      var id = window.ids - 1;
      $('#lyric_text_'+id).trigger('click');
    }

    function sync_lyrics(){
      //console.log(window.timecodes);
      if(window.timecodes.length < 1){
        $('#preview').text('');
        return;
      }
      //console.log(window.timecodes);
      // Presume if not that we have at least some timecodes to work with!
      var time = timecode();
      var lyric_line = window.timecodes.find(function(line){
        if(!('start' in line)) return false;
        if(line.start < time){
          if(!('end' in line)) return true; // No end so definitely yes!
          if(line.end > time) return true;
          return false;
        }
      });
      if(lyric_line){
        $('#preview').text(lyric_line.text);
      }else{
        // No lyrics here
        $('#preview').text('');
      }
    }

    function timecode(){
      return $('#vid')[0].currentTime;
    }

    function deselect(){
      $('.selected').removeClass('selected');
      window.selected_line = -1;
    }

    function add_timecode(line, text, type){
      var t = timecode();
      //console.log(line);
      if(window.timecodes[line]){
          window.timecodes[line][type] = t;
      }else{
        window.timecodes[line] = {};
        window.timecodes[line][type] = t;
        if(text !== '') window.timecodes[line].text = text;
      }

      $('#lyric_'+type+'_'+line).text(t);
    }

    function push_lyric(text){
      var t = timecode();
      var l = {};
      l.start = t;
      l.text = text;
      window.timecodes.push(l);
      update_list();
    }

    function end_lyric(){
      window.timecodes[window.timecodes.length - 1].end = timecode();
      update_list();
    }

    function update_list(){
      var html = '<table>';
      window.timecodes.forEach(function(line, index){
        if(line.end){
          html += '<tr><td><span class="time" id="start_'+index+'">'+time_to_hms(line.start)+'</span> - <span class="time" id="end_'+index+'">'+time_to_hms(line.end)+'</span>:</td><td><span class="lyrics_text" id="text_'+index+'">'+line.text+'</span></td><td><span class="delete" id="delete_'+index+'">Delete this entry</span></td></tr>';
        }else{
          html += '<tr><td><span class="time" id="start_'+index+'">'+time_to_hms(line.start)+'</span> - (no end yet):</td><td>'+line.text+'</td><td><span class="delete" id="delete_'+index+'">Delete this entry</span></td></tr>';

        }
      });
      html += '</table>';
      $('#list').html(html);
      $('.delete').on('click', delete_sub);
      $('.lyrics_text').on('click', edit_lyric);
      $('.time').on('click', function(evt){
        if(evt.shiftKey){
          set_time($(this).attr('id'))
        }else{
          goto_time($(this).attr('id'));
        }
      });
    }



    function edit_lyric(){
      var id = $(this).attr('id').substring(5);
      $(this).html('<input id="edit_'+id+'" value="'+window.timecodes[id].text+'" />');
      $('#edit_'+id).on('change', function() {
          window.timecodes[id].text = $(this).val();
          update_list();
      });
      $('#edit_'+id).keyup(function(evt) {
        if(evt.keyCode === 13){
          window.timecodes[id].text = $(this).val();
          update_list();
        }
      });
      $('#edit_'+id).focus();
    }

    function click_line(){
      var id = $(this).attr('id').substring(11);
      //console.log(id+' is id');
      if(window.selected_line == id){
        //Deselect this line
        end_lyric();
        deselect();
        return;
      }
      if(window.selected_line != -1 ){
          // There was a previous line, so deselect them and set their end_time
          //$('#lyric_end_'+window.selected_line).text(timecode());
          end_lyric();
          deselect();
      }
        //$('#lyric_start_'+id).text(timecode());
      push_lyric($(this).text());
      $(this).addClass('selected');
      window.selected_line = id;
      //console.log('selected line is '+id);
    }

  function save_subs(){
    download(JSON.stringify(window.timecodes), "lyrics.json", "application/json");
  }

  function load_subs(file){
    window.timecodes = JSON.parse(file);
    update_list();
  }

  function storageAvailable(type) {
    var storage;
    try {
        storage = window[type];
        var x = '__storage_test__';
        storage.setItem(x, x);
        storage.removeItem(x);
        return true;
    }
    catch(e) {
        return e instanceof DOMException && (
            // everything except Firefox
            e.code === 22 ||
            // Firefox
            e.code === 1014 ||
            // test name field too, because code might not be present
            // everything except Firefox
            e.name === 'QuotaExceededError' ||
            // Firefox
            e.name === 'NS_ERROR_DOM_QUOTA_REACHED') &&
            // acknowledge QuotaExceededError only if there's something already stored
            (storage && storage.length !== 0);
    }
}

    function save_opts(){
      for(setting in window.opts){
        localStorage.setItem('format_options_'+setting, window.opts[setting]);
      }
      localStorage.setItem('format_saved', true);
    }

    function load_opts(){
      if(!localStorage.getItem('format_saved')){
        window.opts = {
          text_colour: "#000000",
          bg_colour: "#ffffff", // Alpha needed too
          font_size: 30, // pixels
          font: 'sans-serif',
          bg_type: "full", // possibilities: 'full' border, 'box' box, 'none'
          bg_border: 0,
          bg_opacity: 0.5,
          out_colour: "#000000",
          out_size: 0,
          shad_colour: "#000000",
          shad_off: 0
        };
        return;
      }
      for(setting in window.opts){
        window.opts[setting] = localStorage.getItem('format_options_'+setting);
      }
      display_opts();
      set_opt_controls();
    }

    function wipe_opts(){
      if(!confirm('Are you sure you want to reset formatting?')) return;
      localStorage.clear();
      load_opts();
      display_opts();
      set_opt_controls();
    }

    function click_line_old(){
      var id = $(this).attr('id').substring(11);
      if(window.selected_line == id){
        // This was previously selected, so deselect
        deselect();
        //$('#lyric_end_'+id).text(timecode());
        add_timecode(id, '', 'end');
      }else{
        if(window.selected_line != -1 ){
          // There was a previous line, so deselect them and set their end_time
          //$('#lyric_end_'+window.selected_line).text(timecode());
          add_timecode(window.selected_line, '', 'end');
          deselect();
        }
        //$('#lyric_start_'+id).text(timecode());
        add_timecode(id, $(this).text(), 'start');
        $(this).addClass('selected');
        window.selected_line = id;
      }
    }

    function canvasBlob(callback){
      var canvas = document.createElement('CANVAS');
      var ctx = canvas.getContext('2d');
      var blob;
      canvas.height = 100;
      canvas.width = 1920;
      ctx.fillStyle = "#FF0000";
      ctx.fillRect(0, 0, 150, 75);
      blob = canvas.toBlob(callback, 'image/png');
    }

    function init_worker(){
      // Adapted from videoconverter.js - https://github.com/bgrins/videoconverter.js/blob/master/demo/terminal.js
      window.worker = new Worker("./lyrics_worker.js");
      worker.onmessage = function (event) {
        var message = event.data;
        if (message.type == "ready") {
          window.isWorkerLoaded = true;
          // Probs remove below
          worker.postMessage({
            type: "command",
            arguments: ["-help"]
          });
        } else if (message.type == "stdout") {
          $('#ffmpeg_log').append(document.createTextNode(message.data + "\n"));
        } else if (message.type == "start") {
          $('#ffmpeg_log').text("Worker has received command\n");
        } else if (message.type == "done") {
          stopRunning();
          var buffers = message.data;
          buffers.forEach(function(file) {
            console.log("File recieved", file.name, file.data);
            download(file.data, file.name, "video/quicktime");
          });
        }
      };
    }

    function browser_video(){
      canvasBlob(function(blob) {
        //console.log('Blobbed');
        blob.arrayBuffer().then(function(ab){
            //console.log('Promise resolved');
            //var args = '-formats';
            var data = new Uint8Array(ab);
            //console.log(data);
            var avi_args =  '-nostdin -loop 1 -i img.png -c:v huffyuv -t 15 out.avi';
            var prores_args =  '-nostdin -loop 1 -i img.png -c:v prores_ks -profile:v 4444 -qscale:v 9 -vendor ap10 -pix_fmt yuva444p10le -t 15 out.mov';
            var args = avi_args;
            /*res = call_ffmpeg(
            [{name: 'img.webp', data: data}],
            args.split(' '));
            console.log(res.MEMFS[0].data);
            download(res.MEMFS[0].data, "out.webm", "video/webm");*/
            /*
            var results = ffmpeg_run({
              arguments: args.split(' '),
              files: [
                {
                  name: 'img.png',
                  data: data
                }
              ]
            });
            results.forEach(function(file) {
                console.log("File recieved", file.name, file.data);
                download(file.data, file.name, "video/quicktime");
            });*/
            if(ffmpeg_ready()){
              ffmpeg_start();
              console.log('Launching ffmpeg with args '+args);
              window.worker.postMessage({
                type: 'command',
                arguments: args.split(' '),
                files: [
                  {
                    name: 'img.png',
                    data: data
                  }
                ]
              });
            }
        });
      })
    }

    function call_ffmpeg(memfs, args){
      const result = window.ffmpeg({
        MEMFS: memfs, //[{name: "img.png", }],
        arguments: args, // ["-codecs"],
        print: function(data) {console.log(data)},
        onExit: function(code){
          console.log('Done: '+code);
        }
      });
      return result;
    }

    function adjust_range(){
      var range_id = $(this).attr('id');
      var id = range_id.slice(0, -6); // To remove '_range' bit
      $('#'+id).val($('#'+range_id).val());
      window.opts[id] = $('#'+id).val();
      display_opts();
    }

    function process_video(){
      var in_name = $('#input_video').val();
      if(in_name === ''){
        alert('You haven\'t entered an input filename yet! Enter a filename, or drag the file to the textbox to get its path.');
        return;
      }
      var ffmpeg_command = 'ffmpeg -i "'+in_name+'" -vf ';
      var filtergraph = '';
      window.timecodes.forEach(function(line){
        var bgcol = window.opts.bg_colour+'@'+window.opts.bg_opacity;
        var col = window.opts.text_colour;
        var size = window.opts.font_size; // pixels, I think
        var x_offset = "w / 2 - tw / 2";
        var y_offset = "h - "+size+" * 1.5";  //(max_glyph_h / 2)" //  + ascent";
        var box_edge = '20'; //$('#vid')[0].videoWidth / 2;
        var font = window.opts.font;
        if(!line.end) line.end = $('#vid')[0].duration;
        //console.log('font color='+col);
        var db = 'drawbox="y=ih-'+size*2+':h='+size*2+':t=fill:color='+bgcol+':enable=\'between(t,'+line.start+','+line.end+')\'"';
        var dt = 'drawtext="text='+escape_filter_option(line.text)+':font='+font+':x='+x_offset+':y='+y_offset+':fontcolor='+col+':fontsize='+size+':borderw='+window.opts.out_size+':bordercolor='+window.opts.out_colour+':shadowcolor='+window.opts.shad_colour+':shadowx='+window.opts.shad_off+':shadowy='+window.opts.shad_off+':enable=\'between(t,'+line.start+','+line.end+')\'"';
        //var dt = 'drawtext="text='+escape_filter_option(line.text)+':x='+x_offset+':y='+y_offset+':box=1:boxcolor='+bgcol+':boxborderw='+box_edge+':fontcolor='+col+':fontsize='+size+':enable=\'between(t,'+line.start+','+line.end+')\'"';

        if(filtergraph !== '') filtergraph += ',';
        filtergraph += escape_filter_description(db)+','+escape_filter_description(dt);
        //filtergraph += escape_filter_description(dt);
      });
      ffmpeg_command += escape_filtergraph_for_shell(filtergraph);
      ffmpeg_command += ' "'+$('#output_video').val()+'"';
      //$('#ffmpeg').text(ffmpeg_command);
      //$('#ffmpeg')[0].select();
      //$('#ffmpeg')[0].setSelectionRange(0,99999);
      //document.execCommand("copy");
      $('#ffmpeg').show();
      $('#ffmpeg_command').val(ffmpeg_command);
      $('#ffmpeg_command')[0].select();
      $('#ffmpeg_command')[0].setSelectionRange(0,99999);
      if(document.execCommand("copy")){
        $('#ffmpeg').hide();
        $('#confirmation').text('FFMPEG command has been copied to clipboard: paste into a command line window to make the video');
      }else{
        $('#confirmation').text('FFMPEG command is in textbox at bottom of page – copy and paste into a command line window to make the video');
      }

    }
  </script>
</head>
<body>
  <div id="header" class="w3-container w3-blue">
    <h1>Make your own lyrics video!</h1>
  </div>
  <p>Choose a video file to work with: <input type="file" id="vid_file"/></p>
  <button id="save_subs">Save work in progress </button> Or load from a previous save: <input type="file" id="sub_file"/>
  <div id="video_container">
    <video id="vid" controls="true">
      <source src="http://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4" id="video_here" />
       Your browser does not support HTML5 video.
    </video>
    <div id="preview_container">
      <div id="preview"></div>
    </div>
  </div>
  <div class="w3-bar w3-black">
    <button class="w3-bar-item w3-button tablink w3-blue" onclick="openTab(event, 'add_lyrics')">Import</button>
    <button class="w3-bar-item w3-button tablink" id="place_tab" onclick="openTab(event, 'place_lyrics')">Place</button>
    <button class="w3-bar-item w3-button tablink" onclick="openTab(event, 'edit_lyrics')">Edit</button>
    <button class="w3-bar-item w3-button tablink" onclick="openTab(event, 'options')">Format</button>
    <button class="w3-bar-item w3-button tablink" onclick="openTab(event, 'export')">Export</button>
  </div>
<div id="add_lyrics" class="tab_option">
  <h2>Import lyrics</h2>
  <p>Copy your lyrics here, then press 'Process lyrics!' (or hit shift-return) to split into lines:</p>
  <p><textarea id="lyrics" class="lyrics_array"></textarea></p>
  <button type="button" id="clear">Clear</button>
  <button type="button" id="process">Process lyrics!</button>
</div>
<div id="place_lyrics" class="tab_option" style="display: none;">
  <h2>Place subtitles</h2>
  <p>If you want to add and display another lyric quickly, you can type it here and press enter:</p>
  <input type="text" id="single_line" class="mousetrap"/><button type="button" id="add">Display</button>
  <p>Click on a lyric to make it appear at this moment. Click again to make it disappear (or click the next lyric). You can also press up or down. Press space to start/pause the video.</p>
  <div id="lyrics_array" class="lyrics_array"></div>
</div>
<div id="edit_lyrics" class="tab_option" style="display: none;">
<h2>Edit subtitles</h2>
<p>Click on times to jump to them in the video. Shift-click to set to current time. Click on subtitle text to edit it.
<div id="list" class="lyrics_array" style="font-family: monospace; white-space:pre;"></div>
</div>
<div id="options" class="tab_option" style="display: none;">
<h2>Format subtitles</h2>
<p>
Text colour: <input class="opt_control" type='color' id='text_colour' value='#ffffff'/>
Text size: <input type='range' min='1' max='100' value='50' class='slider' id='font_size_range' />
<input id="font_size" class="opt_control" value="50" size="3"/>
</p><p>
Font: <input id="font" class="opt_control" type="text" value='sans-serif' size="10"/>  (you should be able to type any on your system, or the standard families 'sans-serif', 'serif' or 'monospace')
</p>
<p>
Outline colour: <input class="opt_control" type='color' id='out_colour' value='#000000'/>
Outline thickness: <input type='range' min='0' max='5' value='0' class='slider' id='out_size_range' />
<input id="out_size" class="opt_control" value="0" size="3"/>
</p>
<p>
Shadow colour: <input class="opt_control" type='color' id='shad_colour' value='#000000'/>
Shadow offset: <input type='range' min='0' max='5' value='0' class='slider' id='shad_off_range' />
<input id="shad_off" class="opt_control" value="0" size="3"/>
</p>
<p>
Background colour: <input class="opt_control" type='color' id='bg_colour' value='#ffffff'/>
Background opacity: <input type='range' min='0' max='1' value='0.5' step="0.1" class='slider' id='bg_opacity_range' />
<input id="bg_opacity" class="opt_control" value="0.5" size="3"/>
</p>
<div id="saving">
<button id="reset_opts" type="button">Reset to defaults</button>
<button id="save_opts" type="button">Save as new defaults</button>
<p>
<button id="wipe_opts" type="button">Factory reset (wipe defaults)</button>
</div>
</div>
<div id="export" class="tab_option" style="display: none;">
  <h2>Export your file</h2>
  You can export the subtitle file ready to 'Burn in' using Handbrake, or you can get the (complicated) command you could use to add these subtitles with exact formatting in FFMPEG. Make sure you enter the full pathnames of the input and output video here if you want to run the FFMPEG command.
  <p>Input video: <input type="text" id="input_video" value="" /></p>
  <p>Output video: <input type="text" id="output_video" value="output.mp4" /></p>
    <button type=button id="export_srt">Export lyrics as SRT file</button> (SRT files are widely accepted, but don't contain any formatting information)
    <p />
    <button type=button id="export_ass">Export lyrics as ASS file</button> (ASS files contain most formatting information, but not all readers can use this information – FFMPEG can though)
    <p />
    <button type=button id="make_video">Create FFMPEG command! (This will probably give you the best formatting.)</button>
    <div id="confirmation" style="color: red;"></div>
    <p>(note: this will copy to the clipboard a command you can run to make your video. You need to have installed FFMPEG first.)</p>
  <div id="ffmpeg">FFMPEG command: <input type="text" id="ffmpeg_command" /></div>
  <button id="in_browser" type="button">Experimental in-browser FFMPEG</button>
  <div id="ffmpeg_log" class="lyrics_array" style="font-family: monospace; white-space:pre;"></div>
</div>
 </body>
</html>
