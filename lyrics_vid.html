<!DOCTYPE html>
<html lang="en">
<head>
  <title>Make a lyrics video</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <style>
  .line_text {
    cursor: pointer;
    border-style: solid;
    border-width: 1px;
    border-color: blue;
    background-color: lightblue;
  }
  .selected {
    background-color: pink;
  }
  .lyrics_array {
    height:200px;
    width: 100%;
    border:1px solid #ccc;
    overflow: scroll;
  }
  #video_container {
    position: relative;
  }

  #vid {
  }
  #preview_container {
    position: absolute;
    width: 100%;
    bottom: 0;
    background: rgba(255,255,255,0.5);
    pointer-events: none;
  }
  #preview {
    font-family: "Verdana", sans-serif;
    font-size: 30px;
    line-height: 2;
    text-align: center;
    vertical-align: middle;
    color: black;
    pointer-events: none;
  }
  .time {
    cursor: pointer;
    color:blue;
    text-decoration: underline;
  }
  .delete {
    cursor: pointer;
    color:red;
    text-decoration: underline;
  }
  .lyrics_text {
    cursor: pointer;
  }
  </style>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="mousetrap.min.js"></script>
  <script>
    $(document).ready(function() {
      $('#process').on('click', process_lyrics);
      $('#clear').on('click', function(){
        $('#lyrics').val('');
      });
      $('#vid_file').on('change', function(evt){
          var source = $('#video_here');
          source[0].src = URL.createObjectURL(this.files[0]);
          source.parent()[0].load();
      });
      $('#vid').on('canplay', vid_ready);
      $('#vid').on('timeupdate', sync_lyrics);
      $('#make_video').on('click', process_video);
      $('#export_srt').on('click', export_srt);
      $('#export_ass').on('click', export_ass);
      $('.instructions').hide();
      $('.options').hide();
      $('.opt_control').on('change', change_opt);
      $('.opt_control').on('input', change_opt);
      $('#lyrics').on('keyup', function(e){
        if(e.keyCode === 13 && e.shiftKey){
          e.preventDefault();
          process_lyrics();
        }
      });
      $('#single_line').on('keyup', function(e){
        if(e.keyCode === 13){
          e.preventDefault();
          add_line();
        }
      });
      $('#add').on('click', add_line);
      $('#opts').on('click', function(){
        $('.options').toggle();
      });
      $('#ffmpeg').hide();
      //$('#list_div').hide();
      window.selected_line = -1;
      window.timecodes = [];
      window.ids = 0;
      window.opts = {
        text_colour: "#000000",
        bg_colour: "#ffffff", // Alpha needed too
        font_size: 30, // pixels
        bg_type: "full", // possibilities: 'full' border, 'box' box, 'none'
        bg_border: 0,
        bg_opacity: 0.5
      };
      //window.font_options = ["Arial", "Times New Roman", "Verdana", "Courier New"];
      window.os_specific = {
        "Mac": {
          script_ext: 'command',
          script: '#!/bin/bash\necho "Enter the name of the input video (you can probably just drag and drop it on this window):"\nread -r name\nffmpeg -i ${name} ',
          script_mime: 'application/x-shellscript'
        },
        "*nix": {
          script_ext: 'sh',
          script: '#!/bin/bash\necho "Enter the name of the input video (you can probably just drag and drop it on this window):"\nread -r name\nffmpeg -i ${name} ',
          script_mime: 'application/x-shellscript'
        },
        "Windows":{
          script_ext: 'bat',
          script: '@ECHO OFF\nset /P name="Enter the path of the input video: "\nffmpeg -i %name% ',
          script_mime: 'application/x-bat'
        }
      }
      set_os();
      set_opt_controls();
      display_opts();
      Mousetrap.bind('space', function(e){
        if (e.preventDefault) {
        e.preventDefault();
    } else {
        // internet explorer
        e.returnValue = false;
    }
        playpause();
      });
      Mousetrap.bind('down', function(e){
        if (e.preventDefault) {
        e.preventDefault();
    } else {
        // internet explorer
        e.returnValue = false;
    }
        next_lyric();
      });
      Mousetrap.bind('up', function(e){
        if (e.preventDefault) {
        e.preventDefault();
    } else {
        // internet explorer
        e.returnValue = false;
    }
       prev_lyric();
      });
      $('#lyrics').focus();

          Mousetrap.prototype.stopCallback = function(e, element, combo) {
            if ((' ' + element.className + ' ').indexOf(' mousetrap ') > -1) {
              if(combo != 'space') return false;
          }

          // stop for input, select, and textarea
          return element.tagName == 'INPUT' || element.tagName == 'SELECT' || element.tagName == 'TEXTAREA' || (element.contentEditable && element.contentEditable == 'true');

          }
    });

    function set_os(){
      if (navigator.userAgent.indexOf("Win")!=-1) window.osname="Windows";
      if (navigator.userAgent.indexOf("Mac")!=-1) window.osname="Mac";
      if (navigator.userAgent.indexOf("X11")!=-1) window.osname="*nix";
      if (navigator.userAgent.indexOf("Linux")!=-1) window.osname="*nix";
    }

    function textcol(){
      $('#preview').css('color', $('#text_colour').val());
    }

    function display_opts(){
      $('#preview').css('color', window.opts.text_colour);
      var bg_colour = "rgba(" + window.opts.bg_colour.match(/[A-Za-z0-9]{2}/g).map(function(v) { return parseInt(v, 16) }).join(",") + ","+window.opts.bg_opacity+")";

      $('#preview_container').css('background', bg_colour);
      $('#preview').css('font-size', window.opts.font_size/2 +'px');
    }

    function set_opt_controls(){
      for(o in window.opts){
        $('#'+o).val(window.opts[o]);
      };
      $('#font_size_range').val(window.opts.font_size);
      $('#bg_opacity_range').val(window.opts.bg_opacity);
    }

    function openTab(evt, tabName) {
      var i;
      var x = document.getElementsByClassName("tab_option");
      for (i = 0; i < x.length; i++) {
        x[i].style.display = "none";
      }
      tablinks = document.getElementsByClassName("tablink");
      for (i = 0; i < x.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" w3-blue", "");
      }
      document.getElementById(tabName).style.display = "block";
      evt.currentTarget.className += " w3-blue";
    }


    function goto_time(id){
      if(id.match(/start/)){
        var num = id.substring(6);
        $('#vid')[0].currentTime = window.timecodes[num].start;
      }else if(id.match(/end/)){
        var num = id.substring(4);
        $('#vid')[0].currentTime = window.timecodes[num].end;
      }
    }

    function set_time(id){
      if(id.match(/start/)){
        var num = id.substring(6);
        window.timecodes[num].start = $('#vid')[0].currentTime;
      }else if(id.match(/end/)){
        var num = id.substring(4);
        window.timecodes[num].end = $('#vid')[0].currentTime;
      }
      update_list();
    }

    function delete_sub(){
      var id = $(this).attr('id').substring(7);
      window.timecodes.splice(id, 1);
      update_list();
    }

    function bgcol(){
      $('#preview_container').css('background', $('#bg_colour').val()+'88');
    }

    function vid_ready(){
      $('#video_container').width($('#vid')[0].videoWidth/2);
      $('#vid').width($('#video_container').width());
    }

    function change_opt(){
      var opt = $(this).attr('id');
      window.opts[opt] = $(this).val();
      display_opts();
    }

    function escape_filter_option(text){
      return text.replace(/([:'])/g, "\\$1");
    }
    function escape_filter_description(text){
      return text.replace(/([\[\]\\\',;])/g, "\\$1");
    }

    function escape_filtergraph_for_shell(text){
      return text.replace(/\\/g, '\\\\');
    }

    function time_to_hms(time){
      if(!time) return time_to_hms($('#vid')[0].duration);
      var s = Math.floor(time);
      var ms = Math.floor ((time - s)*1000);
      var date = new Date(null);
      date.setSeconds(s, ms);
      return date.toISOString().substr(11, 12).replace(/\./, ',');
    }

    function time_to_ass(time){
      if(!time) return time_to_ass($('#vid')[0].duration);
      var s = Math.floor(time);
      var hs = Math.floor ((time - s)*100);
      var date = new Date(null);
      date.setSeconds(s, hs*10);
      return date.toISOString().substr(12, 10);
    }

    function export_srt(){
      var file = '';
      for(var i = 0; i < window.timecodes.length; i++){
        var num = i+1;
        file += '' + num + '\n';
        file += time_to_hms(window.timecodes[i].start) + ' --> '+time_to_hms(window.timecodes[i].end) + '\n';
        file += window.timecodes[i].text+'\n\n';

      }
      download(file, "lyrics.srt", 'text/srt');
    }

    function rgb_to_bgr(col, alpha = 1){
      // Can presume 7-digit hex notation
      var r = col[1]+col[2];
      var g = col[3]+col[4];
      var b = col[5]+col[6];
      var a = Math.round(alpha * 255).toString(16);
      return '&H'+a.toUpperCase()+b.toUpperCase()+g.toUpperCase()+r.toUpperCase()+'&';
    }

    function export_ass(){
      var wrap = 0;
      var spacer = '';
      if(window.opts.bg_type == "full"){
        wrap = 2; // For workaround to enable full-width box
        var char = 'G';
        var num = Math.floor($('#vid')[0].videoWidth / (window.opts.font_size * 2));
        console.log(num);
        spacer = '{\\1a&HFF&}{\\bord0}{\\shad0}'+char.repeat(num)+'{\\r}{\\1a&H00&}';
      }
      var res=false;
      var res_text = '';
      if(res) res_text = 'PlayResX: '+$('#vid')[0].videoWidth+'\nPlayResY: '+$('#vid')[0].videoHeight+'\n';
      var file = '[Script Info]\nScriptType: V4.00+\n'+res_text+'WrapStyle: '+wrap+'\n\n';
      file += '[V4+ Styles]\nFormat: Name, Fontname, Fontsize, PrimaryColour, BackColour, Bold, Italic, BorderStyle, Outline, Shadow, Alignment, MarginL, MarginR, MarginV\n';
      file += 'Style: Default,Arial,'+window.opts.font_size+','+rgb_to_bgr(window.opts.text_colour)+','+rgb_to_bgr(window.opts.bg_colour, window.opts.bg_opacity)+',0,0,4,0,0,2,0,0,0\n\n'; // TODO update with variables
      file += '[Events]\nFormat: Start, End, Style, Text\n';
      for(var i = 0; i < window.timecodes.length; i++){
        var num = i+1;
        file += 'Dialogue: '+time_to_ass(window.timecodes[i].start) + ',' + time_to_ass(window.timecodes[i].end) + ',Default,'+spacer+window.timecodes[i].text+spacer+'\n';
      }
      download(file, "lyrics.ass", 'text/ass');
    }

    function playpause(){
      if($('#vid')[0].paused) $('#vid')[0].play();
      else $('#vid')[0].pause();
    }

    function next_lyric(){
      if(window.selected_line == window.ids - 1){
        $('#lyric_text_'+window.selected_line).trigger('click');
        return; // To deselect last one
      }
      var new_id = +window.selected_line+1; // Means when nothing is selected it will move to the start
      $('#lyric_text_'+new_id).trigger('click');
    }

    function prev_lyric(){
      if(window.selected_line < 0){
        var num = +window.ids - 1;
        $('#lyric_text_'+num).trigger('click');
        return;
      }; // No prev ID
      if(window.selected_line == 0){
        $('#lyric_text_0').trigger('click');  // To deselect
        return;
      }
      var new_id = window.selected_line-1;
      $('#lyric_text_'+new_id).trigger('click');
    }


    function download(data, filename, type) {
    var file = new Blob([data], {type: type});
    if (window.navigator.msSaveOrOpenBlob) // IE10+
        window.navigator.msSaveOrOpenBlob(file, filename);
    else { // Others
        var a = document.createElement("a"),
                url = URL.createObjectURL(file);
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        setTimeout(function() {
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }, 0);
    }
}

    function process_lyrics(){
      var lyrics = $.trim($('#lyrics').val());
      $('#lyrics').val('');
      $('#lyrics').blur();
      if(lyrics === '') return;
      //window.timecodes = []; // Reset everything
      var lines = lyrics.match(/[^\r\n]+/g);
      var inside = '';
      lines.forEach(function(line){
        inside += '<div id="lyric_line_'+window.ids+'"></div><span class="line_text" id="lyric_text_'+window.ids+'">'+line+'</span>' // from <span id="lyric_start_'+ln+'">0</span> seconds to <span id="lyric_end_'+ln+'">0</span> seconds</div>';
        window.ids++;
      });
      existing = $('#lyrics_array').html();
      $('#lyrics_array').html(existing+inside);
      $('.line_text').on('click', click_line);
      var evt = new MouseEvent('click', {view: window, bubbles: true, cancelable: true});
      $('#place_tab')[0].dispatchEvent(evt);
    }

    function add_line(){
      var h = $('#lyrics_array').html();
      var line = $('#single_line').val();
      $('#single_line').val('');
      //$('#single_line').blur();
      if(line === '') return;
      h += '<div id="lyric_line_'+window.ids+'"></div><span class="line_text" id="lyric_text_'+window.ids+'">'+line+'</span>';
      window.ids++;
      $('#lyrics_array').html(h);
      $('.line_text').on('click', click_line);
      // Auto-click line
      var id = window.ids - 1;
      $('#lyric_text_'+id).trigger('click');
    }

    function sync_lyrics(){
      //console.log(window.timecodes);
      if(window.timecodes.length < 1){
        $('#preview').text('');
        return;
      }
      //console.log(window.timecodes);
      // Presume if not that we have at least some timecodes to work with!
      var time = timecode();
      var lyric_line = window.timecodes.find(function(line){
        if(!('start' in line)) return false;
        if(line.start < time){
          if(!('end' in line)) return true; // No end so definitely yes!
          if(line.end > time) return true;
          return false;
        }
      });
      if(lyric_line){
        $('#preview').text(lyric_line.text);
      }else{
        // No lyrics here
        $('#preview').text('');
      }
    }

    function timecode(){
      return $('#vid')[0].currentTime;
    }

    function deselect(){
      $('.selected').removeClass('selected');
      window.selected_line = -1;
    }

    function add_timecode(line, text, type){
      var t = timecode();
      //console.log(line);
      if(window.timecodes[line]){
          window.timecodes[line][type] = t;
      }else{
        window.timecodes[line] = {};
        window.timecodes[line][type] = t;
        if(text !== '') window.timecodes[line].text = text;
      }

      $('#lyric_'+type+'_'+line).text(t);
    }

    function push_lyric(text){
      var t = timecode();
      var l = {};
      l.start = t;
      l.text = text;
      window.timecodes.push(l);
      update_list();
    }

    function end_lyric(){
      window.timecodes[window.timecodes.length - 1].end = timecode();
      update_list();
    }

    function update_list(){
      var html = '<table>';
      window.timecodes.forEach(function(line, index){
        if(line.end){
          html += '<tr><td><span class="time" id="start_'+index+'">'+time_to_hms(line.start)+'</span> - <span class="time" id="end_'+index+'">'+time_to_hms(line.end)+'</span>:</td><td><span class="lyrics_text" id="text_'+index+'">'+line.text+'</span></td><td><span class="delete" id="delete_'+index+'">Delete this entry</span></td></tr>';
        }else{
          html += '<tr><td><span class="time" id="start_'+index+'">'+time_to_hms(line.start)+'</span> - (no end yet):</td><td>'+line.text+'</td><td><span class="delete" id="delete_'+index+'">Delete this entry</span></td></tr>';

        }
      });
      html += '</table>';
      $('#list').html(html);
      $('.delete').on('click', delete_sub);
      $('.lyrics_text').on('click', edit_lyric);
      $('.time').on('click', function(evt){
        if(evt.shiftKey){
          set_time($(this).attr('id'))
        }else{
          goto_time($(this).attr('id'));
        }
      });
    }



    function edit_lyric(){
      var id = $(this).attr('id').substring(5);
      $(this).html('<input id="edit_'+id+'" value="'+window.timecodes[id].text+'" />');
      $('#edit_'+id).on('change', function() {
          window.timecodes[id].text = $(this).val();
          update_list();
      });
      $('#edit_'+id).keyup(function(evt) {
        if(evt.keyCode === 13){
          window.timecodes[id].text = $(this).val();
          update_list();
        }
      });
      $('#edit_'+id).focus();
    }

    function click_line(){
      var id = $(this).attr('id').substring(11);
      //console.log(id+' is id');
      if(window.selected_line == id){
        //Deselect this line
        end_lyric();
        deselect();
        return;
      }
      if(window.selected_line != -1 ){
          // There was a previous line, so deselect them and set their end_time
          //$('#lyric_end_'+window.selected_line).text(timecode());
          end_lyric();
          deselect();
      }
        //$('#lyric_start_'+id).text(timecode());
      push_lyric($(this).text());
      $(this).addClass('selected');
      window.selected_line = id;
      //console.log('selected line is '+id);
    }

    function click_line_old(){
      var id = $(this).attr('id').substring(11);
      if(window.selected_line == id){
        // This was previously selected, so deselect
        deselect();
        //$('#lyric_end_'+id).text(timecode());
        add_timecode(id, '', 'end');
      }else{
        if(window.selected_line != -1 ){
          // There was a previous line, so deselect them and set their end_time
          //$('#lyric_end_'+window.selected_line).text(timecode());
          add_timecode(window.selected_line, '', 'end');
          deselect();
        }
        //$('#lyric_start_'+id).text(timecode());
        add_timecode(id, $(this).text(), 'start');
        $(this).addClass('selected');
        window.selected_line = id;
      }
    }

    function process_video(){
      var ffmpeg_command = 'ffmpeg -i '+$('#input_video').val()+' -vf ';
      var filtergraph = '';
      window.timecodes.forEach(function(line){
        var bgcol = window.opts.bg_colour+'@'+window.opts.bg_opacity;
        var col = window.opts.text_colour;
        var size = window.opts.font_size; //pixels, I think
        var x_offset = "w / 2 - tw / 2";
        var y_offset = "h - "+size+" * 1.5";  //(max_glyph_h / 2)" //  + ascent";
        var box_edge = '20'; //$('#vid')[0].videoWidth / 2;
        if(!line.end) line.end = $('#vid')[0].duration;
        //console.log('font color='+col);
        var db = 'drawbox="y=ih-'+size*2+':h='+size*2+':t=fill:color='+bgcol+':enable=\'between(t,'+line.start+','+line.end+')\'"';
        var dt = 'drawtext="text='+escape_filter_option(line.text)+':x='+x_offset+':y='+y_offset+':fontcolor='+col+':fontsize='+size+':enable=\'between(t,'+line.start+','+line.end+')\'"';
        //var dt = 'drawtext="text='+escape_filter_option(line.text)+':x='+x_offset+':y='+y_offset+':box=1:boxcolor='+bgcol+':boxborderw='+box_edge+':fontcolor='+col+':fontsize='+size+':enable=\'between(t,'+line.start+','+line.end+')\'"';

        if(filtergraph !== '') filtergraph += ',';
        filtergraph += escape_filter_description(db)+','+escape_filter_description(dt);
        //filtergraph += escape_filter_description(dt);
      });
      ffmpeg_command += escape_filtergraph_for_shell(filtergraph);
      ffmpeg_command += ' '+$('#output_video').val();
      //$('#ffmpeg').text(ffmpeg_command);
      //$('#ffmpeg')[0].select();
      //$('#ffmpeg')[0].setSelectionRange(0,99999);
      //document.execCommand("copy");
      $('#ffmpeg').show();
      $('#ffmpeg_command').val(ffmpeg_command);
      $('#ffmpeg_command')[0].select();
      $('#ffmpeg_command')[0].setSelectionRange(0,99999);
      if(document.execCommand("copy")){
        $('#ffmpeg').hide();
        alert('FFMPEG command has been copied to clipboard: paste into a command line window to make the video');
      }else{
        alert('FFMPEG command is in textbox at bottom of page – copy and paste into a command line window to make the video');
      }

    }
  </script>
</head>
<body>
  <div id="header" class="w3-container w3-blue">
    <h1>Make your own lyrics video!</h1>
  </div>
  <p>Choose a video file to work with: <input type="file" id="vid_file"/></p>
  <div id="video_container">
    <video id="vid" controls="true">
      <source src="http://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4" id="video_here">
       Your browser does not support HTML5 video.
    </video>
    <div id="preview_container">
      <div id="preview"></div>
    </div>
  </div>
  <div class="w3-bar w3-black">
    <button class="w3-bar-item w3-button tablink w3-blue" onclick="openTab(event, 'add_lyrics')">Import</button>
    <button class="w3-bar-item w3-button tablink" id="place_tab" onclick="openTab(event, 'place_lyrics')">Place</button>
    <button class="w3-bar-item w3-button tablink" onclick="openTab(event, 'edit_lyrics')">Edit</button>
    <button class="w3-bar-item w3-button tablink" onclick="openTab(event, 'options')">Format</button>
    <button class="w3-bar-item w3-button tablink" onclick="openTab(event, 'export')">Export</button>
  </div>
<div id="add_lyrics" class="tab_option">
  <h2>Import lyrics</h2>
  <p>Copy your lyrics here, then press 'Process lyrics!' (or hit shift-return) to split into lines:</p>
  <p><textarea id="lyrics" class="lyrics_array"></textarea></p>
  <button type="button" id="clear">Clear</button>
  <button type="button" id="process">Process lyrics!</button>
</div>
<div id="place_lyrics" class="tab_option" style="display: none;">
  <h2>Place subtitles</h2>
  <p>If you want to add and display another lyric quickly, you can type it here and press enter:</p>
  <input type="text" id="single_line" class="mousetrap"/><button type="button" id="add">Display</button>
  <p>Click on a lyric to make it appear at this moment. Click again to make it disappear (or click the next lyric). You can also press up or down. Press space to start/pause the video.</p>
  <div id="lyrics_array" class="lyrics_array"></div>
</div>
<div id="edit_lyrics" class="tab_option" style="display: none;">
<h2>Edit subtitles</h2>
<p>Click on times to jump to them in the video. Shift-click to set to current time. Click on subtitle text to edit it.
<div id="list" class="lyrics_array" style="font-family: monospace; white-space:pre;"></div>
</div>
<div id="options" class="tab_option" style="display: none;">
<h2>Format subtitles</h2>
<p>
Text colour: <input class="opt_control" type='color' id='text_colour' value='#ffffff'/>
Text size: <input type='range' min='1' max='100' value='30' class='slider' id='font_size_range' oninput="font_size.value = font_size_range.value; window.opts.font_size = font_size.value; display_opts();"/>
<input id="font_size" class="opt_control" value="30" size="3"/>
</p>
<p>
Background colour: <input class="opt_control" type='color' id='bg_colour' value='#ffffff'/>
Background opacity: <input type='range' min='0' max='1' value='0.5' step="0.1" class='slider' id='bg_opacity_range' oninput="bg_opacity.value = bg_opacity_range.value; window.opts.bg_opacity = bg_opacity.value; display_opts();"/>
<input id="bg_opacity" class="opt_control" value="0.5" size="3"/>
</p>
</div>
<div id="export" class="tab_option" style="display: none;">
  <h2>Export your file</h2>
  You can export the subtitle file ready to 'Burn in' using Handbrake, or you can get the (complicated) command you could use to add these subtitles with exact formatting in FFMPEG. Make sure you enter the full pathnames of the input and output video here if you want to run the FFMPEG command.
  <p>Input video: <input type="text" id="input_video" value="input.mov" /></p>
  <p>Output video: <input type="text" id="output_video" value="output.mov" /></p>
    <button type=button id="export_srt">Export lyrics as SRT file</button>
    <p />
    <button type=button id="export_ass">Export lyrics as ASS file</button>
    <p />
    <button type=button id="make_video">Create FFMPEG command!</button>
    <p>(note: this will copy to the clipboard a command you can run to make your video. You need to have installed FFMPEG first.)</p>
  <div id="ffmpeg">FFMPEG command: <input type="text" id="ffmpeg_command" /></div>
</div>
 </body>
</html>
