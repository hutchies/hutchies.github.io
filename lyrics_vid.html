<!DOCTYPE html>
<html lang="en">
<head>
  <title>Make a lyrics video</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
  .line_text {
    cursor: pointer;
    border-style: solid;
    border-width: 1px;
    border-color: blue;
    background-color: lightblue;
  }
  .selected {
    background-color: pink;
  }
  .lyrics_array {
    height:200px;
    width: 500px;
    border:1px solid #ccc;
    overflow: scroll;
  }
  .options {
    visibility: hidden;
  }
  #video_container {
    position: relative;
  }

  #vid {
  }
  #preview_container {
    position: absolute;
    width: 100%;
    bottom: 0;
    background: rgba(255,255,255,0.5);
    pointer-events: none;
  }
  #preview {
    font-family: "Arial", sans-serif;
    font-size: 20pt;
    line-height: 2;
    text-align: center;
    vertical-align: middle;
    color: white;
    pointer-events: none;
  }
  .time {
    cursor: pointer;
    color:blue;
    text-decoration: underline;
  }
  .delete {
    cursor: pointer;
    color:red;
    text-decoration: underline;
  }
  </style>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="mousetrap.min.js"></script>
  <script>
    $(document).ready(function() {
      $('#process').on('click', process_lyrics);
      $('#clear').on('click', function(){
        $('#lyrics').val('');
      });
      $('#vid_file').on('change', function(evt){
          var source = $('#video_here');
          source[0].src = URL.createObjectURL(this.files[0]);
          source.parent()[0].load();
      });
      $('#vid').on('canplay', vid_ready);
      $('#vid').on('timeupdate', sync_lyrics);
      $('#make_video').on('click', process_video);
      $('#export_srt').on('click', export_srt);
      $('.instructions').hide();
      $('#text_colour').on('change', textcol);
      $('#bg_colour').on('change', bgcol);
      $('#add').on('click', add_line);
      //$('#list_div').hide();
      window.selected_line = -1;
      window.timecodes = [];
      window.ids = 0;
      Mousetrap.bind('space', function(e){
        if (e.preventDefault) {
        e.preventDefault();
    } else {
        // internet explorer
        e.returnValue = false;
    }
        playpause();
      });
      Mousetrap.bind('down', function(e){
        if (e.preventDefault) {
        e.preventDefault();
    } else {
        // internet explorer
        e.returnValue = false;
    }
        next_lyric();
      });
      Mousetrap.bind('up', function(e){
        if (e.preventDefault) {
        e.preventDefault();
    } else {
        // internet explorer
        e.returnValue = false;
    }
       prev_lyric();
      });
    });

    function textcol(){

      $('#preview').css('color', $('#text_colour').val());
    }

    function goto_time(){
      var id=$(this).attr('id');
      if(id.match(/start/)){
        var num = id.substring(6);
        $('#vid')[0].currentTime = window.timecodes[num].start;
      }else if(id.match(/end/)){
        var num = id.substring(4);
        $('#vid')[0].currentTime = window.timecodes[num].end;
      }
    }

    function delete_sub(){
      var id = $(this).attr('id').substring(7);
      window.timecodes.splice(id, 1);
      update_list();
    }

    function bgcol(){
      $('#preview_container').css('background', $('#bg_colour').val()+'88');
    }

    function vid_ready(){
      $('#video_container').width($('#vid')[0].videoWidth/2);
      $('#vid').width($('#video_container').width());
    }

    function escape_filter_option(text){
      return text.replace(/([:'])/g, "\\$1");
    }
    function escape_filter_description(text){
      return text.replace(/([\[\]\\\',;])/g, "\\$1");
    }

    function escape_filtergraph_for_shell(text){
      return text.replace(/\\/g, '\\\\');
    }

    function time_to_hms(time){
      if(!time) return time_to_hms($('#vid')[0].duration);
      var s = Math.floor(time);
      var ms = Math.floor ((time - s)*1000);
      console.log(s);
      console.log(ms);
      var date = new Date(null);
      date.setSeconds(s, ms);
      return date.toISOString().substr(11, 12).replace(/\./, ',');
    }

    function export_srt(){
      var file = '';
      for(var i = 0; i < window.timecodes.length; i++){
        var num = i+1;
        file += '' + num + '\n';
        file += time_to_hms(window.timecodes[i].start) + ' --> '+time_to_hms(window.timecodes[i].end) + '\n';
        file += window.timecodes[i].text+'\n\n';

      }
      download(file, "lyrics.srt", 'text/srt');
    }

    function playpause(){
      if($('#vid')[0].paused) $('#vid')[0].play();
      else $('#vid')[0].pause();
    }

    function next_lyric(){
      if(window.selected_line == window.ids - 1){
        $('#lyric_text_'+window.selected_line).trigger('click');
        return; // To deselect last one
      }
      var new_id = +window.selected_line+1; // Means when nothing is selected it will move to the start
      $('#lyric_text_'+new_id).trigger('click');
    }

    function prev_lyric(){
      if(window.selected_line < 0){
        var num = +window.ids - 1;
        $('#lyric_text_'+num).trigger('click');
        return;
      }; // No prev ID
      if(window.selected_line == 0){
        $('#lyric_text_0').trigger('click');  // To deselect
        return;
      }
      var new_id = window.selected_line-1;
      $('#lyric_text_'+new_id).trigger('click');
    }


    function download(data, filename, type) {
    var file = new Blob([data], {type: type});
    if (window.navigator.msSaveOrOpenBlob) // IE10+
        window.navigator.msSaveOrOpenBlob(file, filename);
    else { // Others
        var a = document.createElement("a"),
                url = URL.createObjectURL(file);
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        setTimeout(function() {
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }, 0);
    }
}

    function process_lyrics(){
      var lyrics = $.trim($('#lyrics').val());
      if(lyrics === '') return;
      window.timecodes = []; // Reset everything
      var lines = lyrics.match(/[^\r\n]+/g);
      var inside = '';
      lines.forEach(function(line){
        inside += '<div id="lyric_line_'+window.ids+'"></div><span class="line_text" id="lyric_text_'+window.ids+'">'+line+'</span>' // from <span id="lyric_start_'+ln+'">0</span> seconds to <span id="lyric_end_'+ln+'">0</span> seconds</div>';
        window.ids++;
      });
      $('#lyrics_array').html(inside);
      $('.line_text').on('click', click_line);
      $('.instructions').show();
    }

    function add_line(){
      var h = $('#lyrics_array').html();
      var line = $('#single_line').val();
      if(line === '') return;
      h += '<div id="lyric_line_'+window.ids+'"></div><span class="line_text" id="lyric_text_'+window.ids+'">'+line+'</span>';
      window.ids++;
      $('#lyrics_array').html(h);
      $('.line_text').on('click', click_line);
      $('.instructions').show();
    }

    function sync_lyrics(){
      //console.log(window.timecodes);
      if(window.timecodes.length < 1){
        $('#preview').text('');
        return;
      }
      //console.log(window.timecodes);
      // Presume if not that we have at least some timecodes to work with!
      var time = timecode();
      var lyric_line = window.timecodes.find(function(line){
        if(!('start' in line)) return false;
        if(line.start < time){
          if(!('end' in line)) return true; // No end so definitely yes!
          if(line.end > time) return true;
          return false;
        }
      });
      if(lyric_line){
        $('#preview').text(lyric_line.text);
      }else{
        // No lyrics here
        $('#preview').text('');
      }
    }

    function timecode(){
      return $('#vid')[0].currentTime;
    }

    function deselect(){
      $('.selected').removeClass('selected');
      window.selected_line = -1;
    }

    function add_timecode(line, text, type){
      var t = timecode();
      //console.log(line);
      if(window.timecodes[line]){
          window.timecodes[line][type] = t;
      }else{
        window.timecodes[line] = {};
        window.timecodes[line][type] = t;
        if(text !== '') window.timecodes[line].text = text;
      }

      $('#lyric_'+type+'_'+line).text(t);
    }

    function push_lyric(text){
      var t = timecode();
      var l = {};
      l.start = t;
      l.text = text;
      window.timecodes.push(l);
      update_list();
    }

    function end_lyric(){
      window.timecodes[window.timecodes.length - 1].end = timecode();
      update_list();
    }

    function update_list(){
      var html = '<table>';
      window.timecodes.forEach(function(line, index){
        if(line.end){
          html += '<tr><td><span class="time" id="start_'+index+'">'+time_to_hms(line.start)+'</span> - <span class="time" id="end_'+index+'">'+time_to_hms(line.end)+'</span>:</td><td>'+line.text+'</td><td><span class="delete" id="delete_'+index+'">Delete this entry</span></td></tr>';
        }else{
          html += '<tr><td><span class="time" id="start_'+index+'">'+time_to_hms(line.start)+'</span> - (no end yet):</td><td>'+line.text+'</td><td><span class="delete" id="delete_'+index+'">Delete this entry</span></td></tr>';

        }
      });
      html += '</table>';
      $('#list').html(html);
      $('.delete').on('click', delete_sub);
      $('.time').on('click', goto_time);
    }

    function click_line(){
      var id = $(this).attr('id').substring(11);
      console.log(id+' is id');
      if(window.selected_line == id){
        //Deselect this line
        end_lyric();
        deselect();
        return;
      }
      if(window.selected_line != -1 ){
          // There was a previous line, so deselect them and set their end_time
          //$('#lyric_end_'+window.selected_line).text(timecode());
          end_lyric();
          deselect();
      }
        //$('#lyric_start_'+id).text(timecode());
      push_lyric($(this).text());
      $(this).addClass('selected');
      window.selected_line = id;
      console.log('selected line is '+id);
    }

    function click_line_old(){
      var id = $(this).attr('id').substring(11);
      if(window.selected_line == id){
        // This was previously selected, so deselect
        deselect();
        //$('#lyric_end_'+id).text(timecode());
        add_timecode(id, '', 'end');
      }else{
        if(window.selected_line != -1 ){
          // There was a previous line, so deselect them and set their end_time
          //$('#lyric_end_'+window.selected_line).text(timecode());
          add_timecode(window.selected_line, '', 'end');
          deselect();
        }
        //$('#lyric_start_'+id).text(timecode());
        add_timecode(id, $(this).text(), 'start');
        $(this).addClass('selected');
        window.selected_line = id;
      }
    }

    function process_video(){
      var ffmpeg_command = 'ffmpeg -i "'+$('#video_here')[0].src+'" -vf ';
      var filtergraph = '';
      window.timecodes.forEach(function(line){
        var bgcol = $('#bg_colour').val()+'88';
        var col = $('#text_colour').val();
        var size = 24;
        var x_offset = "w / 2 - tw / 2";
        var y_offset = "h - th";
        if(!line.end) line.end = $('#vid')[0].duration;
        var dt = 'drawtext="text='+escape_filter_option(line.text)+':x='+x_offset+':y='+y_offset+':box=1:boxcolor='+bgcol+':fontcolor='+col+':fontsize='+size+':enable=\'between(t,'+line.start+','+line.end+')\'"';
        if(filtergraph !== '') filtergraph += ',';
        filtergraph += escape_filter_description(dt);
      });
      ffmpeg_command += escape_filtergraph_for_shell(filtergraph);
      ffmpeg_command += ' output.mp4';
      $('#ffmpeg').text(ffmpeg_command);
      //$('#ffmpeg')[0].select();
      //$('#ffmpeg')[0].setSelectionRange(0,99999);
      document.execCommand("copy");
      alert('Command for ffmpeg copied to clipboard');
    }
  </script>
</head>
<body>
  <h1>Make your own lyrics video!</h1>
    <h2>Choosing a video file</h2>
  <p><input type="file" id="vid_file"/></p>
  <div id="video_container">
    <video id="vid" controls="true">
      <source src="http://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4" id="video_here">
       Your browser does not support HTML5 video.
    </video>
    <div id="preview_container">
      <div id="preview"></div>
    </div>
  </div>
  <div id="controls"></div>
  <div>
  <h2>Making subtitles</h2>
  <p>Click on a lyric to make it appear at this moment. Click again to make it disappear (or click the next lyric). You can also press up or down. Press space to start/pause the video.</p>
  <p>Created subtitles will appear in the list to the right, where you can revisit or delete them if needed.</p>
  <table><tr><td><b>Available lyrics (click on lyrics to make them appear)<b><div id="lyrics_array" class="lyrics_array"></div>
  </td><td><b>List of created subtitles (click on times to jump to them)</b>
      <div id="list" class="lyrics_array" style="font-family: monospace; white-space:pre;">
      </div>
</td></tr></table>
</div>
  <h2>Adding lyrics</h2>
  <p>Before you can start adding subtitles, you will need to add some lyrics. If you want to add a single lyric line, type it below and press 'add':</p>
  <input type="text" id="single_line" /><button type="button" id="add">Add line</button>
  <p>You can also add lots of lyrics at once. Copy them here, then press 'Process lyrics!' to split into lines:</p>
  <p><textarea id="lyrics" rows="10" cols="50"></textarea></p>
  <button type="button" id="clear">Clear</button>
  <button type="button" id="process">Process lyrics!</button>
  <div>
  <h2>Exporting your file</h2>
  You can export the subtitle file ready to 'Burn in' using Handbrake, or you can get the (complicated) command you could use to add these subtitles in FFMPEG (not recommended at the moment).
    <button type=button id="export_srt">Export lyrics as SRT file</button>
    <button type=button id="make_video">Get FFMPEG command</button>
  </div>
  <div id="ffmpeg"></div>
  <div class="options"><h2>Lyric format options</h2>
  <p>
  Text colour: <input type='color' id='text_colour' value='#000000'/>
  </p>
  <p>
  Background colour: <input type='color' id='bg_colour' value='#ffffff'/>
  </p>
</div>
</body>
</html>
